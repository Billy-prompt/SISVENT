<!DOCTYPE html>
<html lang="es">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Registro de Venta</title>
    <link rel="stylesheet" href="/static/css/styles_ventas.css">
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.5.0/css/all.min.css">
</head>
<body>

<!-- Formulario principal -->
<form action="/ventas/registrar/formulario" method="POST">
    <h1>Registro de Nueva Venta</h1>
    <fieldset>
        <legend>Detalles de la Venta</legend>

        <!-- Campo: Producto con autocompletado -->
        <label for="products">Producto:</label>
        <input type="text" id="products" class="form-control" placeholder="Escriba para buscar..." list="listaProductos">
        <datalist id="listaProductos">
            {% for product in products %}
                <option value="{{ product.product }}" 
                    data-id="{{ product.id_product }}"
                    data-precio="{{ product.sale_price }}" 
                    data-stock="{{ product.stock }}">
                    {{ product.product }} - ${{ product.sale_price }} 
                    {% if product.stock == 0 %}(Sin stock){% endif %}
                </option>
            {% endfor %}
        </datalist>

        <!-- Campo: Cantidad -->
        <label for="quantity">Cantidad:</label>
        <input type="number" id="quantity" name="cantidad" class="form-control" min="1" value="1" required>

        <!-- Precio unitario -->
        <label for="price_display">Precio Unitario:</label>
        <input type="text" id="price_display" class="form-control" readonly>
        <input type="hidden" id="price" name="precio">

        <!-- Total -->
        <label for="total_display">Total:</label>
        <input type="text" id="total_display" class="form-control" readonly>
        <input type="hidden" id="total" name="total">

        <!-- Fecha -->
        <label for="fecha">Fecha de Venta:</label>
        <input type="date" id="fecha" name="fecha" class="form-control" required readonly>
        <br><br>

        <!-- Botones -->
        <button type="button" id="agregar-item" class="btn btn-secondary mt-3">Agregar Producto</button>
        <a href="/home" class="btn btn-secondary mt-3">Home üè†</a>

        <!-- Tabla detalle -->
        <table border="1" id="tabla-detalle" style="margin-top: 15px;">
            <thead>
                <tr>
                    <th>Producto</th>
                    <th>Cantidad</th>
                    <th>Precio Unitario</th>
                    <th>Subtotal</th>
                    <th>Acciones</th>
                </tr>
            </thead>
            <tbody></tbody>
        </table>

        <!-- Total general -->
        <label for="total_general_display">Total General:</label>
        <input type="text" id="total_general_display" class="form-control" readonly>
        <input type="hidden" id="total_general" name="total_general">
    </fieldset>

    <!-- Botones finales -->
    <button type="submit" class="btn btn-primary">Registrar Venta</button>
    <button type="reset" class="btn btn-danger">Limpiar Formulario</button>
</form>

<script>
document.addEventListener("DOMContentLoaded", () => {
    // Formateador de moneda
    const formatoMoneda = new Intl.NumberFormat('es-CO', {
        style: 'currency',
        currency: 'COP'
    });

    // Fecha autom√°tica
    const fechaInput = document.getElementById("fecha");
    const hoy = new Date();
    fechaInput.value = `${hoy.getFullYear()}-${String(hoy.getMonth() + 1).padStart(2, '0')}-${String(hoy.getDate()).padStart(2, '0')}`;

    // Inputs
    const productoInput = document.getElementById("products");
    const cantidadInput = document.getElementById("quantity");

    const precioHidden = document.getElementById("price");
    const precioDisplay = document.getElementById("price_display");

    const totalHidden = document.getElementById("total");
    const totalDisplay = document.getElementById("total_display");

    const totalGeneralHidden = document.getElementById("total_general");
    const totalGeneralDisplay = document.getElementById("total_general_display");

    const agregarBtn = document.getElementById("agregar-item");
    const tablaDetalle = document.querySelector("#tabla-detalle tbody");

    // Actualizar precio y total
    function actualizarPrecioYTotal() {
        const selectedOption = document.querySelector(`#listaProductos option[value="${productoInput.value}"]`);
        if (!selectedOption) return;

        const precio = parseFloat(selectedOption.dataset.precio || 0);
        const cantidad = parseInt(cantidadInput.value) || 0;
        const subtotal = precio * cantidad;

        // Hidden ‚Üí backend
        precioHidden.value = precio.toFixed(2);
        totalHidden.value = subtotal.toFixed(2);

        // Display ‚Üí usuario
        precioDisplay.value = formatoMoneda.format(precio);
        totalDisplay.value = formatoMoneda.format(subtotal);
    }

    // Eventos de cambio
    productoInput.addEventListener("change", actualizarPrecioYTotal);
    cantidadInput.addEventListener("input", actualizarPrecioYTotal);

    // Agregar producto a la tabla
    agregarBtn.addEventListener("click", () => {
        const selectedOption = document.querySelector(`#listaProductos option[value="${productoInput.value}"]`);
        if (!selectedOption) {
            alert("Seleccione un producto v√°lido.");
            return;
        }

        const nombreProducto = productoInput.value;
        const idProducto = selectedOption.dataset.id;
        const precio = parseFloat(precioHidden.value);
        const cantidad = parseInt(cantidadInput.value);
        const stock = parseInt(selectedOption.dataset.stock || 0);
        const subtotal = precio * cantidad;

        if (cantidad <= 0 || isNaN(precio)) {
            alert("Ingrese una cantidad v√°lida.");
            return;
        }
        if (cantidad > stock) {
            alert(`No hay suficiente stock. Disponible: ${stock}`);
            return;
        }

        // Crear fila
        const fila = document.createElement("tr");
        fila.innerHTML = `
            <td>${nombreProducto} <input type="hidden" name="products" value="${idProducto}"></td>
            <td>${cantidad} <input type="hidden" name="quantity" value="${cantidad}"></td>
            <td>${formatoMoneda.format(precio)}</td>
            <td>${formatoMoneda.format(subtotal)}</td>
            <td><button type="button" class="eliminar-item"><i class="fas fa-trash-alt"></i> Eliminar</button></td>
        `;

        // Bot√≥n eliminar
        fila.querySelector(".eliminar-item").addEventListener("click", () => {
            totalGeneralHidden.value = (parseFloat(totalGeneralHidden.value || 0) - subtotal).toFixed(2);
            totalGeneralDisplay.value = formatoMoneda.format(totalGeneralHidden.value);
            fila.remove();
        });

        // Agregar fila a tabla
        tablaDetalle.appendChild(fila);

        // Actualizar total general
        totalGeneralHidden.value = (parseFloat(totalGeneralHidden.value || 0) + subtotal).toFixed(2);
        totalGeneralDisplay.value = formatoMoneda.format(totalGeneralHidden.value);

        // Reset inputs
        cantidadInput.value = "1";
        productoInput.value = "";
        precioHidden.value = "";
        totalHidden.value = "";
        precioDisplay.value = "";
        totalDisplay.value = "";
    });

    // Validaci√≥n al enviar
    const formulario = document.querySelector("form");
    formulario.addEventListener("submit", (event) => {
        if (document.querySelectorAll("#tabla-detalle tbody tr").length === 0) {
            alert("Debe agregar al menos un producto.");
            event.preventDefault();
        }
    });
});
</script>
</body>
</html>

