<!DOCTYPE html>
<html lang="es">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Registro de Venta</title>
    <link rel="stylesheet" href="/static/css/styles_ventas.css">
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.5.0/css/all.min.css">
</head>
<body>

<h1>Registro de Nueva Venta</h1>

<form action="/ventas/registrar/formulario" method="POST">
    <fieldset>
        <legend>Detalles de la Venta</legend>

        <label for="products">Producto:</label>
        <input type="text" id="products" class="form-control" placeholder="Escriba para buscar..." list="listaProductos">
        <datalist id="listaProductos">
        {% for product in products %}
            <option value="{{ product.product }}" 
                data-id="{{ product.id_product }}"
                data-precio="{{ product.sale_price }}" 
                data-stock="{{ product.stock }}">
                {{ product.product }} - ${{ product.sale_price }} 
                {% if product.stock == 0 %}(Sin stock){% endif %}
            </option>
        {% endfor %}
        </datalist>

        <label for="quantity">Cantidad:</label>
        <input type="number" id="quantity" name="cantidad" class="form-control" min="1" value="1" required>

        <label for="price">Precio Unitario:</label>
        <input type="number" id="price" name="precio" class="form-control" step="0.01" readonly>

        <label for="total">Total:</label>
        <input type="number" id="total" name="total" class="form-control" step="0.01" readonly>

        <label for="fecha">Fecha de Venta:</label>
        <input type="date" id="fecha" name="fecha" class="form-control" required readonly>
        <br></br>
        <button type="button" id="agregar-item" class="btn btn-secondary mt-3">Agregar Producto</button>
        
        <a href="/home" class="btn btn-secondary mt-3">Home üè†</a>

        <table border="1" id="tabla-detalle" style="margin-top: 15px;">
            <thead>
                <tr>
                    <th>Producto</th>
                    <th>Cantidad</th>
                    <th>Precio Unitario</th>
                    <th>Subtotal</th>
                    <th>Acciones</th>
                </tr>
            </thead>
            <tbody></tbody>
        </table>

        <label for="total_general">Total General:</label>
        <input type="number" id="total_general" name="total_general" class="form-control" step="0.01" readonly>
    </fieldset>

    <button type="submit" class="btn btn-primary">Registrar Venta</button>
    <button type="reset" class="btn btn-danger">Limpiar Formulario</button>
</form>

<!-- Validar que haya al menos un producto antes de enviar -->
<script>
document.addEventListener("DOMContentLoaded", () => {
    const formulario = document.querySelector("form");
    formulario.addEventListener("submit", (event) => {
        if (document.querySelectorAll("#tabla-detalle tbody tr").length === 0) {
            alert("Debe agregar al menos un producto a la venta.");
            event.preventDefault();
        }
    });

    // Fecha autom√°tica
    const fechaInput = document.getElementById("fecha");
    const hoy = new Date();
    fechaInput.value = `${hoy.getFullYear()}-${String(hoy.getMonth() + 1).padStart(2, '0')}-${String(hoy.getDate()).padStart(2, '0')}`;

    const productoInput = document.getElementById("products");
    const cantidadInput = document.getElementById("quantity");
    const precioInput = document.getElementById("price");
    const totalInput = document.getElementById("total");
    const agregarBtn = document.getElementById("agregar-item");
    const tablaDetalle = document.querySelector("#tabla-detalle tbody");
    const totalGeneralInput = document.getElementById("total_general");

    function actualizarPrecioYTotal() {
        const selectedOption = document.querySelector(`#listaProductos option[value="${productoInput.value}"]`);
        if (!selectedOption) return;
        const precio = parseFloat(selectedOption.dataset.precio || 0);
        const cantidad = parseInt(cantidadInput.value) || 0;
        precioInput.value = precio.toFixed(2);
        totalInput.value = (precio * cantidad).toFixed(2);
    }

    productoInput.addEventListener("change", actualizarPrecioYTotal);
    cantidadInput.addEventListener("input", actualizarPrecioYTotal);

    agregarBtn.addEventListener("click", () => {
        const selectedOption = document.querySelector(`#listaProductos option[value="${productoInput.value}"]`);
        if (!selectedOption) {
            alert("Seleccione un producto v√°lido.");
            return;
        }
        const nombreProducto = productoInput.value;
        const idProducto = selectedOption.dataset.id;
        const precio = parseFloat(precioInput.value);
        const cantidad = parseInt(cantidadInput.value);
        const stock = parseInt(selectedOption.dataset.stock || 0);
        const subtotal = precio * cantidad;

        if (cantidad <= 0 || isNaN(precio)) {
            alert("Ingrese una cantidad v√°lida.");
            return;
        }
        if (cantidad > stock) {
            alert(`No hay suficiente stock para este producto. Stock disponible: ${stock}`);
            return;
        }

        const fila = document.createElement("tr");
        fila.innerHTML = `
            <td>${nombreProducto} <input type="hidden" name="products" value="${idProducto}"></td>
            <td>${cantidad} <input type="hidden" name="quantity" value="${cantidad}"></td>
            <td>$${precio.toFixed(2)}</td>
            <td>$${subtotal.toFixed(2)}</td>
            <td><button type="button" class="eliminar-item"><i class="fas fa-trash-alt"></i> Eliminar</button></td>
        `;

        fila.querySelector(".eliminar-item").addEventListener("click", () => {
            totalGeneralInput.value = (parseFloat(totalGeneralInput.value || 0) - subtotal).toFixed(2);
            fila.remove();
        });

        tablaDetalle.appendChild(fila);
        totalGeneralInput.value = (parseFloat(totalGeneralInput.value || 0) + subtotal).toFixed(2);

        cantidadInput.value = "1";
        precioInput.value = "";
        totalInput.value = "";
        productoInput.value = "";
    });
});
</script>

</body>
</html>
