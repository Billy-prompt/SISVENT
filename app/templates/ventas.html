<!DOCTYPE html>
<html lang="es">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Registro de Venta</title>
    <link rel="stylesheet" href="/static/css/styles_ventas.css">
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.5.0/css/all.min.css">
    <div class="col-md-4 mb-4">
        <div class="card shadow-sm">
                <div class="card-body">
                <a href="/home" class="btn btn-outline-success">Home</a>
            </div>
        </div>
    </div>

</head>
<body>

<h1>Registro de Nueva Venta</h1>

<form action="/ventas/registrar/formulario" method="POST">

    <fieldset>
        <legend>Detalles de la Venta</legend>

        <label for="products">Producto:</label>
        <select id="products" class="form-select">
            <option value="" disabled selected>Seleccione un producto</option>
            {% for product in products %}
                <option value="{{ product.id_product }}" 
                        data-precio="{{ product.sale_price }}" 
                        data-stock="{{ product.stock }}"
                        {% if product.stock == 0 %} disabled {% endif %}>
                    {{ product.product }} - ${{ product.sale_price }} 
                    {% if product.stock == 0 %}(Sin stock){% endif %}
                </option>
            {% endfor %}
        </select>

        <label for="cantidad">Cantidad:</label>
        <input type="number" id="quantity" name="cantidad" min="1" value="1" required><br><br>

        <label for="precio">Precio Unitario:</label>
        <input type="number" id="price" name="precio" step="0.01" readonly><br><br>

        <label for="total">Total:</label>
        <input type="number" id="total" name="total" step="0.01" readonly><br><br>

        <label for="fecha">Fecha de Venta:</label>
        <input type="date" id="fecha" name="fecha" required><br><br>

        <button type="button" id="agregar-item">Agregar Producto</button>

        <table border="1" id="tabla-detalle" style="margin-top: 15px;">
            <thead>
                <tr>
                    <th>Producto</th>
                    <th>Cantidad</th>
                    <th>Precio Unitario</th>
                    <th>Subtotal</th>
                    <th>Acciones</th>
                </tr>
            </thead>
            <tbody></tbody>
        </table>

        <label for="total_general">Total General:</label>
        <input type="number" id="total_general" name="total_general" step="0.01" readonly><br><br>
    </fieldset>

    <button type="submit">Registrar Venta</button>
    <button type="reset">Limpiar Formulario</button>

</form>

<!-- Validar que haya al menos un producto antes de enviar -->
<script>
document.addEventListener("DOMContentLoaded", () => {
    const formulario = document.querySelector("form");
    formulario.addEventListener("submit", (event) => {
        const filas = document.querySelectorAll("#tabla-detalle tbody tr");
        if (filas.length === 0) {
            alert("Debe agregar al menos un producto a la venta.");
            event.preventDefault();
        }
    });
});
</script>

<!-- Fecha automática -->
<script>
window.addEventListener("DOMContentLoaded", () => {
    const fechaInput = document.getElementById("fecha");
    const hoy = new Date();
    const yyyy = hoy.getFullYear();
    const mm = String(hoy.getMonth() + 1).padStart(2, '0');
    const dd = String(hoy.getDate()).padStart(2, '0');
    fechaInput.value = `${yyyy}-${mm}-${dd}`;
});
</script>

<!-- Lógica de agregar productos -->
<script>
document.addEventListener("DOMContentLoaded", () => {
    const productoSelect = document.getElementById("products");
    const cantidadInput = document.getElementById("quantity");
    const precioInput = document.getElementById("price");
    const totalInput = document.getElementById("total");
    const agregarBtn = document.getElementById("agregar-item");
    const tablaDetalle = document.querySelector("#tabla-detalle tbody");
    const totalGeneralInput = document.getElementById("total_general");

    function actualizarPrecioYTotal() {
        const selectedOption = productoSelect.options[productoSelect.selectedIndex];
        const precio = parseFloat(selectedOption.dataset.precio || 0);
        const cantidad = parseInt(cantidadInput.value) || 0;
        const total = precio * cantidad;

        precioInput.value = precio.toFixed(2);
        totalInput.value = total.toFixed(2);
    }

    productoSelect.addEventListener("change", actualizarPrecioYTotal);
    cantidadInput.addEventListener("input", actualizarPrecioYTotal);

    agregarBtn.addEventListener("click", () => {
        const selectedOption = productoSelect.options[productoSelect.selectedIndex];
        const nombreProducto = selectedOption.textContent.split(" - ")[0];
        const idProducto = selectedOption.value;
        const precio = parseFloat(precioInput.value);
        const cantidad = parseInt(cantidadInput.value);
        const stock = parseInt(selectedOption.dataset.stock || 0);
        const subtotal = precio * cantidad;

        if (!idProducto || cantidad <= 0 || isNaN(precio)) {
            alert("Seleccione un producto válido y una cantidad mayor a 0.");
            return;
        }

        if (cantidad > stock) {
            alert(`No hay suficiente stock para este producto. Stock disponible: ${stock}`);
            return;
        }

        const fila = document.createElement("tr");
        fila.innerHTML = `
            <td>${nombreProducto} <input type="hidden" name="products" value="${idProducto}"></td>
            <td>${cantidad} <input type="hidden" name="quantity" value="${cantidad}"></td>
            <td>$${precio.toFixed(2)}</td>
            <td>$${subtotal.toFixed(2)}</td>
            <td><button type="button" class="eliminar-item" onclick="eliminarFila(this)">
            <i class="fas fa-trash-alt"></i> Eliminar
            </button></td>
        `;

        fila.querySelector(".eliminar-item").addEventListener("click", () => {
            const subtotalStr = fila.children[3].textContent.replace("$", "");
            const subtotal = parseFloat(subtotalStr) || 0;
            const totalAnterior = parseFloat(totalGeneralInput.value) || 0;
            totalGeneralInput.value = (totalAnterior - subtotal).toFixed(2);
            fila.remove();
        });

        tablaDetalle.appendChild(fila);

        const totalAnterior = parseFloat(totalGeneralInput.value) || 0;
        totalGeneralInput.value = (totalAnterior + subtotal).toFixed(2);

        cantidadInput.value = "1";
        precioInput.value = "";
        totalInput.value = "";
        productoSelect.selectedIndex = 0;
    });
});
</script>

</body>
</html>