<!DOCTYPE html>
<html lang="es">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0"> <!-- 游댳 clave para m칩viles -->
    <title>Ingreso de Productos al Stock</title>
    <link rel="stylesheet" href="/static/css/styles_productos.css">
</head>
<body class="bg-light">

<div class="container mt-5">
    <!-- T칤tulo principal del formulario -->
    <h2 class="mb-4">Registrar Ingreso de Productos al Stock</h2>

    <!-- Formulario principal que env칤a datos al backend -->
    <!-- action="/registrar" -> se enviar치 al endpoint /registrar -->
    <!-- method="POST" -> se env칤an los datos como POST -->
    <form id="formulario-productos" action="/registrar" method="POST">

        <!-- Campo: Fecha de Ingreso -->
        <!-- "readonly" evita que el usuario modifique la fecha (se asigna autom치ticamente) -->
        <div class="mb-3">
            <label for="fecha_ingreso" class="form-label">Fecha de Ingreso</label>
            <input type="date" class="form-control" id="fecha_ingreso" name="fecha_ingreso" required readonly>
        </div>

        <!-- Campo: Selecci칩n de Proveedor -->
        <!-- Desplegable con todos los proveedores disponibles -->
        <div class="mb-3">
            <label for="proveedor_select" class="form-label">Proveedor</label>
            <select class="form-select" id="proveedor_select" name="proveedor_nombre" required>
                <!-- Primera opci칩n por defecto deshabilitada -->
                <option value="" selected disabled>Seleccione un proveedor</option>
                <!-- Se rellena din치micamente con proveedores desde el backend -->
                {% for proveedor in proveedores %}
                    <option value="{{ proveedor.supplier_name }}">{{ proveedor.supplier_name }}</option>
                {% endfor %}
            </select>
        </div>

        <hr>
        <h5>Productos</h5>

        <!-- Contenedor donde se almacenan los productos -->
        <!-- Se pueden a침adir m치s con la funci칩n JS agregarProducto() -->
        <div id="productos-container">

            <!-- Primer producto cargado por defecto -->
            <div class="row mb-3 producto-item">
                <!-- Nombre del producto -->
                <div class="col-md-4">
                    <label class="form-label">Nombre del Producto</label>
                    <input type="text" name="productos" class="form-control" placeholder="Ej: Arroz" required>
                </div>

                <!-- Cantidad de unidades -->
                <div class="col-md-2">
                    <label class="form-label">Cantidad</label>
                    <input type="number" name="cantidades" class="form-control" min="1" required>
                </div>

                <!-- Precio de compra del producto -->
                <div class="col-md-2">
                    <label class="form-label">Precio Compra</label>
                    <input type="number" name="precios" class="form-control precio-compra" step="0.01" min="0" required>
                </div>

                <!-- Precio de venta del producto -->
                <div class="col-md-2">
                    <label class="form-label">Precio Venta</label>
                    <input type="number" name="precio_venta" class="form-control" step="0.01" min="0" required>
                </div>

                <!-- Categor칤a del producto -->
                <div class="col-md-2">
                    <label class="form-label">Categor칤a</label>
                    <!-- Select con categor칤as existentes -->
                    <select class="form-select categoria-select">
                        <option value="" disabled selected>Seleccione categor칤a</option>
                        {% for categoria in categorias %}
                            <option value="{{ categoria.category }}">{{ categoria.category }}</option>
                        {% endfor %}
                    </select>
                    <!-- Input opcional para ingresar una nueva categor칤a -->
                    <input type="text" class="form-control mt-1 nueva-categoria" placeholder="Agregar nueva categor칤a">
                </div>
            </div>
        </div>

        <!-- Bot칩n que a침ade din치micamente un nuevo bloque de producto -->
        <!-- onclick="agregarProducto()" -> llama a la funci칩n JS para duplicar el producto -->
        <button type="button" class="btn btn-secondary mb-3" onclick="agregarProducto()">+ A침adir otro producto</button>
        
        <br>
        <hr>

        <!-- Bot칩n principal: env칤a el formulario al backend -->
        <button type="submit" class="btn btn-primary">Registrar Ingreso</button>
        
        <!-- Bot칩n secundario: redirige a la p치gina de inicio -->
        <a href="/home" class="btn btn-outline-secondary">Home 游</a>
        
        <!-- Bot칩n adicional: redirige a la gesti칩n de inventario -->
        <a href="/inventario" class="btn btn-primary">Gesti칩n de Inventario</a>
    </form>
</div>

<script>
// Lista de categor칤as disponibles
let categorias = [];

// Cargar categor칤as desde el backend
function cargarCategoriasEnSelect(selectElement) {
    selectElement.innerHTML = '<option value="" disabled selected>Seleccione categor칤a</option>';
    categorias.forEach(cat => {
        const opt = document.createElement('option');
        opt.value = cat;
        opt.textContent = cat;
        selectElement.appendChild(opt);
    });
}

// Obtener categor칤as del servidor
function obtenerCategorias() {
    fetch("/categorias")
        .then(response => response.json())
        .then(data => {
            categorias = data;
            document.querySelectorAll('.categoria-select').forEach(sel => cargarCategoriasEnSelect(sel));
        });
}

// A침adir nuevo producto
function agregarProducto() {
    const container = document.getElementById('productos-container');
    const nuevoProducto = container.firstElementChild.cloneNode(true);

    nuevoProducto.querySelectorAll('input').forEach(input => input.value = '');
    const selectCategoria = nuevoProducto.querySelector('.categoria-select');
    const nuevaCategoriaInput = nuevoProducto.querySelector('.nueva-categoria');

    cargarCategoriasEnSelect(selectCategoria);
    nuevaCategoriaInput.value = '';

    container.appendChild(nuevoProducto);
}

// Validaci칩n de categor칤as
document.getElementById("formulario-productos").addEventListener("submit", function(e) {
    document.querySelectorAll(".producto-item").forEach(item => {
        const select = item.querySelector(".categoria-select");
        const inputNueva = item.querySelector(".nueva-categoria");

        const categoriaFinal = inputNueva.value.trim() || select.value;

        if (!categoriaFinal) {
            e.preventDefault();
            alert("Debe seleccionar o escribir una categor칤a en cada producto.");
            return;
        }

        select.remove();
        inputNueva.remove();

        const inputHidden = document.createElement("input");
        inputHidden.type = "hidden";
        inputHidden.name = "categorias";
        inputHidden.value = categoriaFinal;
        item.querySelector("div:last-child").appendChild(inputHidden);
    });
});

// Fecha autom치tica
document.addEventListener("DOMContentLoaded", () => {
    const fechaInput = document.getElementById("fecha_ingreso");
    const hoy = new Date();
    const yyyy = hoy.getFullYear();
    const mm = String(hoy.getMonth() + 1).padStart(2, '0');
    const dd = String(hoy.getDate()).padStart(2, '0');
    fechaInput.value = `${yyyy}-${mm}-${dd}`;

    obtenerCategorias();
});

// Actualizar totales por producto
function actualizarTotalesProducto(productoItem) {
    const precioInput = productoItem.querySelector(".precio-compra");
    const cantidadInput = productoItem.querySelector("[name='cantidades']");

    let precio = parseFloat(precioInput.value) || 0;
    let cantidad = parseInt(cantidadInput.value) || 0;
    let total = precio * cantidad;

    actualizarResumenGeneral();
}

// Escuchar cambios en precios y cantidades
document.addEventListener("input", function (e) {
    if (e.target.classList.contains("precio-compra") || e.target.name === "cantidades") {
        const productoItem = e.target.closest(".producto-item");
        actualizarTotalesProducto(productoItem);
    }
});

// Actualizar resumen general
function actualizarResumenGeneral() {
    let totalNeto = 0;

    document.querySelectorAll(".producto-item").forEach(item => {
        const precio = parseFloat(item.querySelector(".precio-compra").value) || 0;
        const cantidad = parseInt(item.querySelector("[name='cantidades']").value) || 0;
        totalNeto += precio * cantidad;
    });

    document.getElementById("total-neto").textContent = totalNeto.toFixed(2);
    document.getElementById("total-final").textContent = totalNeto.toFixed(2);
}
</script>
</body>
</html>


