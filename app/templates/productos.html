<!DOCTYPE html>
<html lang="es">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0"> <!-- üîπ clave para m√≥viles -->
    <title>Ingreso de Productos al Stock</title>
    <link rel="stylesheet" href="/static/css/styles_productos.css">
    <!-- Bootstrap para estilos -->
    <link href="https://cdn.jsdelivr.net/npm/bootstrap@5.3.0/dist/css/bootstrap.min.css" rel="stylesheet">
</head>
<body class="bg-light">

<div class="container mt-5">
    <!-- T√≠tulo principal del formulario -->
    <h2 class="mb-4">Registrar Ingreso de Productos al Stock</h2>

    <!-- Formulario principal que env√≠a datos al backend -->
    <!-- action="/registrar" -> se enviar√° al endpoint /registrar -->
    <!-- method="POST" -> se env√≠an los datos como POST -->
    <form id="formulario-productos" action="/registrar" method="POST">

        <!-- Campo: Fecha de Ingreso -->
        <!-- "readonly" evita que el usuario modifique la fecha (se asigna autom√°ticamente) -->
        <div class="mb-3">
            <label for="fecha_ingreso" class="form-label">Fecha de Ingreso</label>
            <input type="date" class="form-control" id="fecha_ingreso" name="fecha_ingreso" required readonly>
        </div>

        <!-- Campo: Selecci√≥n de Proveedor -->
        <!-- Desplegable con todos los proveedores disponibles -->
        <div class="mb-3">
            <label for="proveedor_select" class="form-label">Proveedor</label>
            <select class="form-select" id="proveedor_select" name="proveedor_nombre" required>
                <!-- Primera opci√≥n por defecto deshabilitada -->
                <option value="" selected disabled>Seleccione un proveedor</option>
                <!-- Se rellena din√°micamente con proveedores desde el backend -->
                {% for proveedor in proveedores %}
                    <option value="{{ proveedor.supplier_name }}">{{ proveedor.supplier_name }}</option>
                {% endfor %}
            </select>
        </div>

        <hr>
        <h5>Productos</h5>

        <!-- Contenedor donde se almacenan los productos -->
        <!-- Se pueden a√±adir m√°s con la funci√≥n JS agregarProducto() -->
        <div id="productos-container">

            <!-- Primer producto cargado por defecto -->
            <div class="row mb-3 producto-item">
                <!-- Nombre del producto -->
                <div class="col-md-4">
                    <label class="form-label">Nombre del Producto</label>
                    <input type="text" name="productos" class="form-control" placeholder="Ej: Arroz" required>
                </div>

                <!-- Cantidad de unidades -->
                <div class="col-md-2">
                    <label class="form-label">Cantidad</label>
                    <input type="number" name="cantidades" class="form-control" min="1" required>
                </div>

                <!-- Precio de compra del producto -->
                <div class="col-md-2">
                    <label class="form-label">Precio Compra</label>
                    <input type="text" name="precios" class="form-control precio-compra" required>
                </div>

                <!-- Precio de venta del producto -->
                <div class="col-md-2">
                    <label class="form-label">Precio Venta</label>
                    <input type="text" name="precio_venta" class="form-control" required>
                </div>

                <!-- Categor√≠a del producto -->
                <div class="col-md-2">
                    <label class="form-label">Categor√≠a</label>
                    <!-- Select con categor√≠as existentes -->
                    <select class="form-select categoria-select">
                        <option value="" disabled selected>Seleccione categor√≠a</option>
                        {% for categoria in categorias %}
                            <option value="{{ categoria.category }}">{{ categoria.category }}</option>
                        {% endfor %}
                    </select>
                    <!-- Input opcional para ingresar una nueva categor√≠a -->
                    <input type="text" class="form-control mt-1 nueva-categoria" placeholder="Agregar nueva categor√≠a">
                </div>
            </div>
        </div>

        <!-- Bot√≥n que a√±ade din√°micamente un nuevo bloque de producto -->
        <!-- onclick="agregarProducto()" -> llama a la funci√≥n JS para duplicar el producto -->
        <button type="button" class="btn btn-secondary mb-3" onclick="agregarProducto()">+ A√±adir otro producto</button>
        
        <br>
        <hr>

        <!-- Bot√≥n principal: env√≠a el formulario al backend -->
        <button type="submit" class="btn btn-register">Registrar Ingreso</button>

        <!-- Bot√≥n secundario: redirige a la p√°gina de inicio -->
        <a href="/home" class="btn btn-home">Home üè†</a>

        <!-- Bot√≥n adicional: redirige a la gesti√≥n de inventario -->
        <a href="/inventario" class="btn btn-inventary">Gesti√≥n de Inventario</a>
    </form>
</div>
<script>
// Lista de categor√≠as disponibles
let categorias = [];

// Formateador de moneda
const formatoMoneda = new Intl.NumberFormat('es-CO', {
    style: 'currency',
    currency: 'COP',
    minimumFractionDigits: 0
});

// Cargar categor√≠as en <select>
function cargarCategoriasEnSelect(selectElement) {
    selectElement.innerHTML = '<option value="" disabled selected>Seleccione categor√≠a</option>';
    categorias.forEach(cat => {
        const opt = document.createElement('option');
        opt.value = cat;
        opt.textContent = cat;
        selectElement.appendChild(opt);
    });
}

// Obtener categor√≠as del servidor
function obtenerCategorias() {
    fetch("/categorias")
        .then(response => response.json())
        .then(data => {
            categorias = data;
            document.querySelectorAll('.categoria-select').forEach(sel => cargarCategoriasEnSelect(sel));
        });
}

// A√±adir nuevo producto
function agregarProducto() {
    const container = document.getElementById('productos-container');
    const nuevoProducto = container.firstElementChild.cloneNode(true);

    // limpiar valores
    nuevoProducto.querySelectorAll('input').forEach(input => input.value = '');
    const selectCategoria = nuevoProducto.querySelector('.categoria-select');
    const nuevaCategoriaInput = nuevoProducto.querySelector('.nueva-categoria');

    cargarCategoriasEnSelect(selectCategoria);
    nuevaCategoriaInput.value = '';

    container.appendChild(nuevoProducto);
}

// Validaci√≥n de categor√≠as antes de enviar
document.getElementById("formulario-productos").addEventListener("submit", function(e) {
    // limpiar precios (quitar formato antes de enviar)
    document.querySelectorAll(".precio-compra, [name='precio_venta']").forEach(input => {
        input.value = limpiarNumero(input.value);
    });

    document.querySelectorAll(".producto-item").forEach(item => {
        const select = item.querySelector(".categoria-select");
        const inputNueva = item.querySelector(".nueva-categoria");

        const categoriaFinal = inputNueva.value.trim() || select.value;

        if (!categoriaFinal) {
            e.preventDefault();
            alert("Debe seleccionar o escribir una categor√≠a en cada producto.");
            return;
        }

        select.remove();
        inputNueva.remove();

        const inputHidden = document.createElement("input");
        inputHidden.type = "hidden";
        inputHidden.name = "categorias";
        inputHidden.value = categoriaFinal;
        item.querySelector("div:last-child").appendChild(inputHidden);
    });
});

// Fecha autom√°tica
document.addEventListener("DOMContentLoaded", () => {
    const fechaInput = document.getElementById("fecha_ingreso");
    const hoy = new Date();
    const yyyy = hoy.getFullYear();
    const mm = String(hoy.getMonth() + 1).padStart(2, '0');
    const dd = String(hoy.getDate()).padStart(2, '0');
    fechaInput.value = `${yyyy}-${mm}-${dd}`;

    obtenerCategorias();
});

// üîπ Quitar formato y devolver solo el n√∫mero
function limpiarNumero(valor) {
    return valor.replace(/[^0-9]/g, ''); // deja solo n√∫meros
}

// Antes de enviar, limpiar valores a n√∫meros enteros
document.getElementById("formulario-productos").addEventListener("submit", function(e) {
    document.querySelectorAll("input[name='precios'], input[name='precio_venta']").forEach(input => {
        input.value = limpiarNumero(input.value); // "$2.500" ‚Üí "2500"
    });
});

// üîπ Formatear a moneda dentro del input
function formatearInput(input) {
    const numero = parseFloat(limpiarNumero(input.value)) || 0;
    input.value = formatoMoneda.format(numero);
}

// üîπ Eventos para inputs de precios
document.addEventListener("focus", function(e) {
    if (e.target.classList.contains("precio-compra") || e.target.name === "precio_venta") {
        e.target.value = limpiarNumero(e.target.value); // mostrar n√∫mero limpio al editar
    }
}, true);

document.addEventListener("blur", function(e) {
    if (e.target.classList.contains("precio-compra") || e.target.name === "precio_venta") {
        formatearInput(e.target); // mostrar moneda al salir del input
        actualizarResumenGeneral();
    }
}, true);

// Actualizar resumen general
function actualizarResumenGeneral() {
    let totalNeto = 0;

    document.querySelectorAll(".producto-item").forEach(item => {
        const precio = parseFloat(limpiarNumero(item.querySelector(".precio-compra").value)) || 0;
        const cantidad = parseInt(item.querySelector("[name='cantidades']").value) || 0;
        totalNeto += precio * cantidad;
    });

    // üîπ mostramos resumen en formato moneda
    document.getElementById("total-neto").textContent = formatoMoneda.format(totalNeto);
    document.getElementById("total-final").textContent = formatoMoneda.format(totalNeto);
}
</script>
</body>
</html>


